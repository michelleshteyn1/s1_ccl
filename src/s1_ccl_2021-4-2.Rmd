---
title: 'Study 1: CCL Members'
author: "Michelle Shteyn Handy"
date: "4/02/2021"
output: 
  html_document:
    code_folding: hide 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Attach packages
library(tidyverse)
library(here)
library(lubridate)
library(janitor)
library(kableExtra)
library(writexl)
```

# Conduct power analysis

The present study employs a repeated measures design with a between-subjects factor (experimental condition: similarity vs. dissimilarity). Stereotyping and projection constructs were computed within-participant across items. Conduct power analysis for repeated measures ANOVA with a within-between interaction, assuming a small effect size (f = 0.1).

```{r}

```


# Read in data and do some wrangling:
Remove participants who:

- Took survey before 3-12-2021 (when Brett sent out the 1st recruitment message)
- Had less than 90% progress
- Completed study in less than 5 minutes or more than 120 minutes (I want people who did not rush and also did it in 1 sitting)

```{r, warning=FALSE, message=FALSE}

# Read in dataset from the "data" subfolder

ccl <- read_csv(here("data","s1_ccl_2021-4-2.csv"))

# Do some wrangling

ccl <- ccl[-c(1:2),] %>% # Delete the first two rows of Qualtrics meta-data
  separate(StartDate, c("date","time"), sep = " ") %>%  # Use the `separate` function to separate into two rows: date and time
  mutate(date = ymd(date)) %>%  # Convert `date` column from character to a stored date class
  filter(date >= as.Date("2021-03-12")) %>%  # Delete any rows before 3-12-2021 
  filter(Status != "Survey Preview") # Delete any survey previews (there was 1)

# We recruited 200 people from a list of 5000 CCL members. After the wrangling above, it shows that 287 CCL members took the survey (this includes those who started it but did not complete it, their data was recorded)

# Do some more wrangling to filter out participants who:
    # had progress less than 90%
    # took the survey in between 5 and 120 minutes (I want people who did not rush and also did      it in 1 sitting)

ccl <- ccl %>% 
  clean_names() %>% # Change variable names to `lower_snake_case`
  mutate(progress = as.numeric(progress), # Convert progress and duration variables into numeric class
         duration_in_seconds = as.numeric(duration_in_seconds),
         duration_in_minutes = duration_in_seconds/60) %>% 
  filter(progress > 90) %>% # Filter for progress over 90% and between 5 and 120 minutes
  filter(duration_in_minutes >= 5) %>% 
  filter(duration_in_minutes <= 120)

# Now we are left with 162 participants being included in analyses.

# Save clean data in `data` folder

# write_csv(ccl, here("data","ccl_clean.csv"))

# I checked it out manually, all of the data looks good now.
```

### Reverse coding

Reverse code ranking items (`self_1`, `stereotype_1`, `robert_1` through `self_8`, `stereotype_8`, `robert_8`) using `mutate::case_when()` such that higher scores indicate greater importance of the reasons for supporting the Energy Innovation & Carbon Dividend Act:

```{r, warning=FALSE, message=FALSE}

# Reverse code self ranking items

ccl <- ccl %>% 
  mutate(self_r_1 = case_when(
                   self_1 == 1 ~ 8, 
                   self_1 == 2 ~ 7, 
                   self_1 == 3 ~ 6, 
                   self_1 == 4 ~ 5, 
                   self_1 == 5 ~ 4,
                   self_1 == 6 ~ 3, 
                   self_1 == 7 ~ 2,
                   self_1 == 8 ~ 1),
         self_r_2 = case_when(
                   self_2 == 1 ~ 8, 
                   self_2 == 2 ~ 7, 
                   self_2 == 3 ~ 6, 
                   self_2 == 4 ~ 5, 
                   self_2 == 5 ~ 4,
                   self_2 == 6 ~ 3, 
                   self_2 == 7 ~ 2,
                   self_2 == 8 ~ 1),
         self_r_3 = case_when(
                   self_3 == 1 ~ 8, 
                   self_3 == 2 ~ 7, 
                   self_3 == 3 ~ 6, 
                   self_3 == 4 ~ 5, 
                   self_3 == 5 ~ 4,
                   self_3 == 6 ~ 3, 
                   self_3 == 7 ~ 2,
                   self_3 == 8 ~ 1),
         self_r_4 = case_when(
                   self_4 == 1 ~ 8, 
                   self_4 == 2 ~ 7, 
                   self_4 == 3 ~ 6, 
                   self_4 == 4 ~ 5, 
                   self_4 == 5 ~ 4,
                   self_4 == 6 ~ 3, 
                   self_4 == 7 ~ 2,
                   self_4 == 8 ~ 1),
         self_r_5 = case_when(
                   self_5 == 1 ~ 8, 
                   self_5 == 2 ~ 7, 
                   self_5 == 3 ~ 6, 
                   self_5 == 4 ~ 5, 
                   self_5 == 5 ~ 4,
                   self_5 == 6 ~ 3, 
                   self_5 == 7 ~ 2,
                   self_5 == 8 ~ 1),
         self_r_6 = case_when(
                  self_6 == 1 ~ 8, 
                   self_6 == 2 ~ 7, 
                   self_6 == 3 ~ 6, 
                   self_6 == 4 ~ 5, 
                   self_6 == 5 ~ 4,
                   self_6 == 6 ~ 3, 
                   self_6 == 7 ~ 2,
                   self_6 == 8 ~ 1),
         self_r_7 = case_when(
                   self_7 == 1 ~ 8, 
                   self_7 == 2 ~ 7, 
                   self_7 == 3 ~ 6, 
                   self_7 == 4 ~ 5, 
                   self_7 == 5 ~ 4,
                   self_7 == 6 ~ 3, 
                   self_7 == 7 ~ 2,
                   self_7 == 8 ~ 1),
         self_r_8 = case_when(
                   self_8 == 1 ~ 8, 
                   self_8 == 2 ~ 7, 
                   self_8 == 3 ~ 6, 
                   self_8 == 4 ~ 5, 
                   self_8 == 5 ~ 4,
                   self_8 == 6 ~ 3, 
                   self_8 == 7 ~ 2,
                   self_8 == 8 ~ 1))

# Reverse code stereotype ranking items

ccl <- ccl %>% 
  mutate(stereotype_r_1 = case_when(
                   stereotype_1 == 1 ~ 8, 
                   stereotype_1 == 2 ~ 7, 
                   stereotype_1 == 3 ~ 6, 
                   stereotype_1 == 4 ~ 5, 
                   stereotype_1 == 5 ~ 4,
                   stereotype_1 == 6 ~ 3, 
                   stereotype_1 == 7 ~ 2,
                   stereotype_1 == 8 ~ 1),
         stereotype_r_2 = case_when(
                   stereotype_2 == 1 ~ 8, 
                   stereotype_2 == 2 ~ 7, 
                   stereotype_2 == 3 ~ 6, 
                   stereotype_2 == 4 ~ 5, 
                   stereotype_2 == 5 ~ 4,
                   stereotype_2 == 6 ~ 3, 
                   stereotype_2 == 7 ~ 2,
                   stereotype_2 == 8 ~ 1),
         stereotype_r_3 = case_when(
                   stereotype_3 == 1 ~ 8, 
                   stereotype_3 == 2 ~ 7, 
                   stereotype_3 == 3 ~ 6, 
                   stereotype_3 == 4 ~ 5, 
                   stereotype_3 == 5 ~ 4,
                   stereotype_3 == 6 ~ 3, 
                   stereotype_3 == 7 ~ 2,
                   stereotype_3 == 8 ~ 1),
         stereotype_r_4 = case_when(
                   stereotype_4 == 1 ~ 8, 
                   stereotype_4 == 2 ~ 7, 
                   stereotype_4 == 3 ~ 6, 
                   stereotype_4 == 4 ~ 5, 
                   stereotype_4 == 5 ~ 4,
                   stereotype_4 == 6 ~ 3, 
                   stereotype_4 == 7 ~ 2,
                   stereotype_4 == 8 ~ 1),
         stereotype_r_5 = case_when(
                   stereotype_5 == 1 ~ 8, 
                   stereotype_5 == 2 ~ 7, 
                   stereotype_5 == 3 ~ 6, 
                   stereotype_5 == 4 ~ 5, 
                   stereotype_5 == 5 ~ 4,
                   stereotype_5 == 6 ~ 3, 
                   stereotype_5 == 7 ~ 2,
                   stereotype_5 == 8 ~ 1),
         stereotype_r_6 = case_when(
                  stereotype_6 == 1 ~ 8, 
                   stereotype_6 == 2 ~ 7, 
                   stereotype_6 == 3 ~ 6, 
                   stereotype_6 == 4 ~ 5, 
                   stereotype_6 == 5 ~ 4,
                   stereotype_6 == 6 ~ 3, 
                   stereotype_6 == 7 ~ 2,
                   stereotype_6 == 8 ~ 1),
         stereotype_r_7 = case_when(
                   stereotype_7 == 1 ~ 8, 
                   stereotype_7 == 2 ~ 7, 
                   stereotype_7 == 3 ~ 6, 
                   stereotype_7 == 4 ~ 5, 
                   stereotype_7 == 5 ~ 4,
                   stereotype_7 == 6 ~ 3, 
                   stereotype_7 == 7 ~ 2,
                   stereotype_7 == 8 ~ 1),
         stereotype_r_8 = case_when(
                   stereotype_8 == 1 ~ 8, 
                   stereotype_8 == 2 ~ 7, 
                   stereotype_8 == 3 ~ 6, 
                   stereotype_8 == 4 ~ 5, 
                   stereotype_8 == 5 ~ 4,
                   stereotype_8 == 6 ~ 3, 
                   stereotype_8 == 7 ~ 2,
                   stereotype_8 == 8 ~ 1))

# Reverse code robert ranking items

ccl <- ccl %>% 
  mutate(robert_r_1 = case_when(
                   robert_1 == 1 ~ 8, 
                   robert_1 == 2 ~ 7, 
                   robert_1 == 3 ~ 6, 
                   robert_1 == 4 ~ 5, 
                   robert_1 == 5 ~ 4,
                   robert_1 == 6 ~ 3, 
                   robert_1 == 7 ~ 2,
                   robert_1 == 8 ~ 1),
         robert_r_2 = case_when(
                   robert_2 == 1 ~ 8, 
                   robert_2 == 2 ~ 7, 
                   robert_2 == 3 ~ 6, 
                   robert_2 == 4 ~ 5, 
                   robert_2 == 5 ~ 4,
                   robert_2 == 6 ~ 3, 
                   robert_2 == 7 ~ 2,
                   robert_2 == 8 ~ 1),
         robert_r_3 = case_when(
                   robert_3 == 1 ~ 8, 
                   robert_3 == 2 ~ 7, 
                   robert_3 == 3 ~ 6, 
                   robert_3 == 4 ~ 5, 
                   robert_3 == 5 ~ 4,
                   robert_3 == 6 ~ 3, 
                   robert_3 == 7 ~ 2,
                   robert_3 == 8 ~ 1),
         robert_r_4 = case_when(
                   robert_4 == 1 ~ 8, 
                   robert_4 == 2 ~ 7, 
                   robert_4 == 3 ~ 6, 
                   robert_4 == 4 ~ 5, 
                   robert_4 == 5 ~ 4,
                   robert_4 == 6 ~ 3, 
                   robert_4 == 7 ~ 2,
                   robert_4 == 8 ~ 1),
         robert_r_5 = case_when(
                   robert_5 == 1 ~ 8, 
                   robert_5 == 2 ~ 7, 
                   robert_5 == 3 ~ 6, 
                   robert_5 == 4 ~ 5, 
                   robert_5 == 5 ~ 4,
                   robert_5 == 6 ~ 3, 
                   robert_5 == 7 ~ 2,
                   robert_5 == 8 ~ 1),
         robert_r_6 = case_when(
                  robert_6 == 1 ~ 8, 
                   robert_6 == 2 ~ 7, 
                   robert_6 == 3 ~ 6, 
                   robert_6 == 4 ~ 5, 
                   robert_6 == 5 ~ 4,
                   robert_6 == 6 ~ 3, 
                   robert_6 == 7 ~ 2,
                   robert_6 == 8 ~ 1),
         robert_r_7 = case_when(
                   robert_7 == 1 ~ 8, 
                   robert_7 == 2 ~ 7, 
                   robert_7 == 3 ~ 6, 
                   robert_7 == 4 ~ 5, 
                   robert_7 == 5 ~ 4,
                   robert_7 == 6 ~ 3, 
                   robert_7 == 7 ~ 2,
                   robert_7 == 8 ~ 1),
         robert_r_8 = case_when(
                   robert_8 == 1 ~ 8, 
                   robert_8 == 2 ~ 7, 
                   robert_8 == 3 ~ 6, 
                   robert_8 == 4 ~ 5, 
                   robert_8 == 5 ~ 4,
                   robert_8 == 6 ~ 3, 
                   robert_8 == 7 ~ 2,
                   robert_8 == 8 ~ 1))

```



# Descriptives

### Race / Ethnicity 

```{r, warning=FALSE,message=FALSE}
ccl %>% 
  group_by(race) %>% 
  summarize(count = n(),
            percent = n()/162*100) %>% 
  kable(col.names = c("Race/Ethnicity",
                      "Counts",
                      "Percent")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left") # How do I get percent to stop at 2 decimal places?
```

```{r, warning=FALSE,message=FALSE}
# Multi-racial (open-ended)
ccl %>% 
  group_by(race_6_text) %>% 
  summarise(count = n()) %>% 
  kable(col.names = c("Race/Ethnicity: Multi-racial - Text",
                      "Counts")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")

# Other (open-ended)
ccl %>% 
  group_by(race_7_text) %>% 
  summarise(count = n()) %>% 
  kable(col.names = c("Race/Ethnicity: Other - Text",
                      "Counts")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")
```

1 'multi-racial' person identified as "white and hispanic"; 1 'other' identified as "European." 

### Age, household income, gender

### Age
Participants ranged from 18 to 84 years old (median age = 66, sd = 16.81 years). Three participants wrote in their own responses: "Older than you," "70 (Retired)," "over 60."
```{r, warning=FALSE,message=FALSE}
## AGE

# First I created a subset of just the age variable so I could filter out the text responses and convert this variable to numeric. After examining the variable, I saw the 3 text responses so I'm going to filter those out here:

age_subset <- ccl %>% 
  select(age) %>% 
  filter(age != "70 (Retired)") %>% 
  filter(age != "Older than you") %>% 
  filter(age != "over 60") 

#Convert the age variable to numeric
age_subset <- age_subset %>% 
  mutate(age = as.numeric(age)) %>% 
  drop_na()

# Find descriptives
#mean(age_subset$age) # 60.37
#sd(age_subset$age) # 16.81
#min(age_subset$age) # 18
#max(age_subset$age) # 84
#median(age_subset$age) # 66
```


### Household income
Median household income category was 5: $50,001 to $75,000.
*Still need to figure out how to label tick marks on x-axis.

```{r, warning=FALSE, message=FALSE}
## HOUSEHOLD INCOME

#First, change family income into a factor variable

ccl <- ccl %>% 
  mutate(fam_inc_num = case_when(
    fam_inc == "Under $15,000" ~ 1,
    fam_inc == "$15,001 - $25,000" ~ 2,
    fam_inc == "$25,001 - $35,000" ~ 3,
    fam_inc == "$35,001 - $50,000" ~ 4, 
    fam_inc == "$50,001 - $75,000" ~ 5,
    fam_inc == "$75,001 - $100,000" ~ 6, 
    fam_inc == "$100,001 - $150,000" ~ 7,
    fam_inc == "$Over 150,000" ~ 8))

#IDK why the labeling doesn't work

ggplot(data = ccl, aes(x = fam_inc_num)) +
  geom_histogram(stat = "count") +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(breaks=c("1","2","3","4","5","6","7"),  
                      labels=c("Under $15,000", "$15,001 - $25,000", "$25,001 - $35,000",
                  "$35,001 - $50,000","$50,001 - $75,000","$75,001 - $100,000",
                  "$100,001 - $150,000"))


#median(ccl$fam_inc_num, na.rm = TRUE) # 5
#min(ccl$fam_inc_num, na.rm = TRUE) # 1
#max(ccl$fam_inc_num, na.rm = TRUE) # 7
```


### Gender

```{r, warning=FALSE, message=FALSE}
## GENDER

ccl %>% 
  group_by(gender) %>% 
  summarise(count = n(),
            percent = n()/(64+97+1)*100) %>% 
  kable(col.names = c("Gender",
                      "Counts",
                      "Percent")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")
```

### Political orientation

```{r, warning=FALSE,message=FALSE}
ccl %>% 
  group_by(ideology) %>% 
  summarise(count = n()) %>% 
  kable(col.names = c("Political Ideology",
                      "Counts")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")


ccl <- ccl %>% 
  mutate(pol_7_pt = case_when(
    dem_strong_weak == "Strong Democrat" ~ 1,
    dem_strong_weak == "Not Very Strong Democrat" ~ 2, 
    closer_dem_rep == "Closer to Democratic Party" ~ 3,
    closer_dem_rep == "Neither" ~ 4,
    closer_dem_rep == "Closer to Republican Party" ~ 5, 
    rep_strong_weak == "Not Very Strong Republican" ~ 6,
    rep_strong_weak == "Strong Republican" ~ 7
  ))

#mean(ccl$pol_7_pt) #2.16

ccl <- ccl %>% 
  mutate(pol_7_pt_char = case_when(
    dem_strong_weak == "Strong Democrat" ~ "Strong Democrat",
    dem_strong_weak == "Not Very Strong Democrat" ~ "Not Very Strong Democrat", 
    closer_dem_rep == "Closer to Democratic Party" ~ "Closer to Democratic Party",
    closer_dem_rep == "Neither" ~ "Neither",
    closer_dem_rep == "Closer to Republican Party" ~ "Closer to Republican Party", 
    rep_strong_weak == "Not Very Strong Republican" ~ "Not Very Strong Republican",
    rep_strong_weak == "Strong Republican" ~ "Strong Republican"
  ))

ccl %>% 
  group_by(pol_7_pt) %>% 
  summarise(count = n()) %>% 
  kable(col.names = c("Political Party Identification",
                      "Counts")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")
```


# Participants' answers on the similarity questions

Check that they reveal expected levels of variance in the expected population: 27.78% enjoy relaxing vacations (vs. 72.22% adventurous), 17.90% enjoy scary movies, and 71.6% enjoy camping (vs. 27.16% staying in and watching TV shows).

```{r, message=FALSE, warning=FALSE}
ccl %>% 
  group_by(vacation) %>% 
  summarize(count = n(),
            percent = n()/162*100) %>% 
   kable(col.names = c("Vacation Preference",
                      "Counts",
                      "Percent")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")

ccl %>% 
  group_by(scary_movie) %>% 
  summarize(count = n(),
            percent = n()/162*100) %>% 
   kable(col.names = c("Enjoy Scary Movies?",
                      "Counts",
                      "Percent")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")

ccl %>% 
  group_by(outdoor_art) %>% 
  summarize(count = n(),
            percent = n()/162*100) %>% 
   kable(col.names = c("Prefer Camping or Staying In and Watching TV Shows?",
                      "Counts",
                      "Percent")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")
```
# How many people in each condition?

80 in the dissimilarity condition, 82 in the similarity condition.
```{r, message=FALSE, warning=FALSE}
ccl %>% 
  group_by(group) %>% 
  summarize(count = n()) %>% 
  kable(col.names = c("Experimental Condition",
                      "Counts")) %>% 
  kable_styling(bootstrap_options = "striped", full_width = FALSE, position = "left")
```


# Calculate stereotyping and projection constructs
For each reason to support the Energy Innovation & Carbon Dividend Act for each participant, a multiple regression predicting target responses with self-responses and typical business owner responses was computed. The mean standardized beta weights were then used as measures of projection (the self-response beta) and stereotyping (the typical businessman response beta)


https://stackoverflow.com/questions/27952653/how-to-loop-repeat-a-linear-regression-in-r

```{r, message=FALSE, warning=FALSE, results='hide'}
# Create a new row called `id` which assigns each Ss an ID number based on the row they are in
ccl <- ccl %>% 
  mutate(id = row_number())

# Use `pivot_longer()` to make the data tidy and have variables for: reason number, self rankings, group rankings, robert rankings
# How do I do pivot longer for 3 variables??
ccl_long <- ccl %>% 
  pivot_longer(
    cols = starts_with("self_r_"),
    names_to = "reason_number",
    names_pattern = "self_r_?(.*)",
    values_to = "self_rankings"
  ) 




# Create vectors (length of 200 ) of a) the projection standardized betas and b) the stereotyping standardized betas (this is too brute force - figure out how to do it on a loop)

# Merge the vectors of the standardized betas for each participant into the original dataset

#Then, bind year_0 as a new variable into the original dataframe.
fish$year_0 <- year_0

# Projection: regressions between self-ratings and Robert ratings for each of the 8 reasons


# Mean standardized beta for projection: 


# Stereotyping: regressions between typical businessman-ratings and Robert ratings for each of the 8 reasons


# Mean standardized beta for stereotyping: 

```


# Effects of similarity on projection and stereotyping

Conduct repeated-measures ANOVA to examine the effect of the similarity manipulation and (time - is that the second factor because participants completed 2 measures to get their S and P scores?) on the projection and stereotyping measures. (from manuscript "the two-level factor of projection and stereotyping")

Use [this resource](https://www.datanovia.com/en/lessons/repeated-measures-anova-in-r/#data-preparation-1)

See example on two-way repeated measures ANOVA.

First, verify that the data meets the required assumptions for two-way repeated measures ANOVA:

```{r}

```


```{r}
# Self-ratings, robert ratings, and businessman ratings are analogous to t1, t2, t3 in the example


```

Fix below so it will do the auto fill-in after broom::tidy

A repeated measures ANOVA revealed a significant interaction of the similarity manipulation on the projection and stereotyping measures, *F*(1,95) = 8.6, *p* < .01. As shown in Figure 1, focused tests were consistent with the central prediction for Study 2: Projection was higher in the similarity than the dissimilarity condition (.42 vs .08), *t*(95) = 3.3, *p* < .01, whereas stereotyping was lower in the similarity condition than the dssimilaity condition, (.42 vs. .08), *t*(95) = 3.3, *p* < .01. The projection and stereotyping measures were significantly negatively correlated (*r* = -.55, *p* < .01).


# Visualize the data

```{r}
#Calculate stereotyping and projection means by similarity condition
#Use group_by, summarize


#Look at Montecito analysis code to make ggplot bar charts of means by similarity condition

# Is a beeswarm plot a good way to visualize this?
```


# Create subset of data of interest to CCL

Select the following two variables of interest to the CCL team, write and save as Excel.

`why_advocacy`: "Why did you get involved with climate advocacy? What were the factors that led you to get involved with CCL?"
`feedback_ccl`: "What feedback do you have about your experience volunteering with CCL? Is it a welcoming space for you as a volunteer?"

```{r}
# Select columns of interest to Brett: `why_advocacy` and `feedback_ccl`

why_advocacy <- ccl %>% 
  select(response_id, why_advocacy) %>% 
  drop_na()

feedback_ccl <- ccl %>% 
  select(response_id, feedback_ccl) %>% 
  drop_na()

# Save subsets as new dataframes in the `data` subfolder

write_xlsx(why_advocacy, here("data","why_advocacy.xlsx"))
write_xlsx(feedback_ccl, here("data","feedback_ccl.xlsx"))

```







